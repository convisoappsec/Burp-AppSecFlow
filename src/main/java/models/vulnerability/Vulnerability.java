package models.vulnerability;

import org.apache.http.HttpEntity;
import org.apache.http.entity.ContentType;
import org.apache.http.entity.mime.MultipartEntityBuilder;
import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.util.ArrayList;

public class Vulnerability {

    private int project_id;//": 2188,                   //OBRIGATORIO
    private int vulnerability_model_id;//": 1,          //OBRIGATORIO

    private String impact;//": "medium",                //OBRIGATORIO
    private String probability;//": "medium",           //OBRIGATORIO

    private String client_impact;//": "client_impact",  //OBRIGATORIO
    private String impact_resume;//": "impact resume", "
    private boolean notification;

    private String failure_type;//": "web",
    private String web_protocol;//": "",
    private String web_method;//": "",
    private String web_url;//": "",
    private String web_parameters;//": "",
    private String web_steps;//": "",
    private String web_request;//": "",
    private String web_response;//": "",
    private Boolean invaded;//": true
    private String invaded_environment_description;//": "invaded environment description",
    private ArrayList<Evidence> vulnerability_archives_attributes;




    public Vulnerability(int projectId, int vulnerabilityModelId, String impact, String probability, Boolean invaded,
                         String invadedDescription, String description, String impactResume, String webProtocol,
                         String webMethod, String webUrl, String webParameters,
                         String webSteps, String webRequest, String webResponse) {

        this.project_id = projectId;
        this.vulnerability_model_id = vulnerabilityModelId;
        this.impact = impact;
        this.probability = probability;
        this.client_impact = description;
        if(impactResume.length() > 255){
            this.impact_resume = impactResume.substring(0,255);
        }else{
            this.impact_resume = impactResume;
        }
        this.web_protocol = webProtocol;
        this.web_method = webMethod;
        this.web_url = webUrl;
        this.web_parameters = webParameters;
        this.web_steps = webSteps;
        this.web_request = webRequest;
        this.web_response = webResponse;
        this.failure_type = "web";
        this.invaded = invaded;
        this.invaded_environment_description = invadedDescription;
        this.vulnerability_archives_attributes = new ArrayList<>();
    }

    public Vulnerability() {
        this.failure_type = "web";
    }

    public int getProject_id() {
        return project_id;
    }

    public void setProject_id(int project_id) {
        this.project_id = project_id;
    }

    public int getVulnerability_model_id() {
        return vulnerability_model_id;
    }

    public void setVulnerability_model_id(int vulnerability_model_id) {
        this.vulnerability_model_id = vulnerability_model_id;
    }

    public String getImpact() {
        return impact;
    }

    public void setImpact(String impact) {
        this.impact = impact;
    }

    public String getProbability() {
        return probability;
    }

    public void setProbability(String probability) {
        this.probability = probability;
    }

    public String getClient_impact() {
        return client_impact;
    }

    public void setClient_impact(String client_impact) {
        this.client_impact = client_impact;
    }

    public String getImpact_resume() {
        return impact_resume;
    }

    public void setImpact_resume(String impact_resume) {

        if(impact_resume.length() > 255){
            this.impact_resume = impact_resume.substring(0,255);
        }else{
            this.impact_resume = impact_resume;
        }
    }

    public String getFailure_type() {
        return failure_type;
    }

    public void setFailure_type(String failure_type) {
        this.failure_type = failure_type;
    }

    public String getWeb_protocol() {
        return web_protocol;
    }

    public void setWeb_protocol(String web_protocol) {
        this.web_protocol = web_protocol;
    }

    public String getWeb_method() {
        return web_method;
    }

    public void setWeb_method(String web_method) {
        this.web_method = web_method;
    }

    public String getWeb_url() {
        return web_url;
    }

    public void setWeb_url(String web_url) {
        this.web_url = web_url;
    }

    public String getWeb_parameters() {
        return web_parameters;
    }

    public void setWeb_parameters(String web_parameters) {
        this.web_parameters = web_parameters;
    }

    public String getWeb_steps() {
        return web_steps;
    }

    public void setWeb_steps(String web_steps) {
        this.web_steps = web_steps;
    }

    public String getWeb_request() {
        return web_request;
    }

    public void setWeb_request(String web_request) {
        this.web_request = web_request;
    }

    public String getWeb_response() {
        return web_response;
    }

    public void setWeb_response(String web_response) {
        this.web_response = web_response;
    }

    public Boolean getInvaded() {
        return invaded;
    }

    public void setInvaded(Boolean invaded) {
        this.invaded = invaded;
    }

    public String getInvaded_environment_description() {
        return invaded_environment_description;
    }

    public void setInvaded_environment_description(String invaded_environment_description) {
        this.invaded_environment_description = invaded_environment_description;
    }

    public ArrayList<Evidence> getVulnerability_archives_attributes() {
        return vulnerability_archives_attributes;
    }

    public void setVulnerability_archives_attributes(ArrayList<Evidence> vulnerability_archives_attributes) {
        this.vulnerability_archives_attributes = vulnerability_archives_attributes;
    }


    public void defineNotification(){
        this.impact = "low";
        this.probability = "low";
        this.impact_resume = "";

        this.invaded = false;
        this.notification = true;
        this.impact_resume = "";

        this.web_protocol = "0";
        this.web_method = "0";
        this.web_url = "0";
        this.web_steps = "0";
        this.web_request = "0";
        this.web_response = "0";
        this.impact_resume = "0";
    }

    public boolean validateCompromisedDescription(){
        if(this.getInvaded_environment_description().isEmpty()){
            return false;
        }else{
            return true;
        }
    }

    public HttpEntity toMultipart() throws FileNotFoundException {
        MultipartEntityBuilder builder = MultipartEntityBuilder.create();
        builder.addTextBody("vulnerability[vulnerability_model_id]", this.vulnerability_model_id+"");
        builder.addTextBody("vulnerability[impact]", this.impact);
        builder.addTextBody("vulnerability[probability]", this.probability);
        builder.addTextBody("vulnerability[client_impact]", this.client_impact);
        builder.addTextBody("vulnerability[impact_resume]", this.impact_resume);
        builder.addTextBody("vulnerability[web_protocol]", this.web_protocol);
        builder.addTextBody("vulnerability[web_method]", this.web_method);
        builder.addTextBody("vulnerability[web_url]", this.web_url);
        builder.addTextBody("vulnerability[web_steps]", this.web_steps);
        builder.addTextBody("vulnerability[web_request]", this.web_request);
        builder.addTextBody("vulnerability[web_response]", this.web_response);
        builder.addTextBody("vulnerability[project_id]", this.project_id+"");
        builder.addTextBody("vulnerability[failure_type]", this.failure_type);

        if(this.notification){
            builder.addTextBody("vulnerability[notification_type]", "true");
        }

        if(this.invaded){
            builder.addTextBody("vulnerability[invaded]", "1");
            builder.addTextBody("vulnerability[invaded_environment_description]", this.invaded_environment_description);
        }else{
            builder.addTextBody("vulnerability[invaded]", "0");
        }
        for (Evidence e :
                this.vulnerability_archives_attributes) {
            File file = new File(e.getPath());
            builder.addBinaryBody("vulnerability[vulnerability_archives_attributes][][archive]",new FileInputStream(file), ContentType.APPLICATION_OCTET_STREAM, e.getName());
        }
        return builder.build();
    }

    @Override
    public String toString() {
        return "Vulnerability{" +
                "project_id=" + project_id +
                ", vulnerability_model_id=" + vulnerability_model_id +
                ", impact='" + impact + '\'' +
                ", probability='" + probability + '\'' +
                ", client_impact='" + client_impact + '\'' +
                ", impact_resume='" + impact_resume + '\'' +
                ", failure_type='" + failure_type + '\'' +
                ", web_protocol='" + web_protocol + '\'' +
                ", web_method='" + web_method + '\'' +
                ", web_url='" + web_url + '\'' +
                ", web_parameters='" + web_parameters + '\'' +
                ", web_steps='" + web_steps + '\'' +
                ", web_request='" + web_request + '\'' +
                ", web_response='" + web_response + '\'' +
                ", invaded=" + invaded +
                ", invaded_environment_description='" + invaded_environment_description + '\'' +
                '}';
    }


}
