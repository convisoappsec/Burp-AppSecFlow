package view.new_vulnerability.custom.popup_menu;

import models.vulnerability.Evidence;
import utilities.Util;
import view.new_vulnerability.NewVulnerabilityTab;

import javax.swing.*;
import javax.swing.filechooser.FileSystemView;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.util.prefs.Preferences;

public class EvidencePopupMenu extends JPopupMenu {
    JMenuItem addEvidence;
    JMenuItem addTextEvidence;
    JMenuItem removeEvidence;
    Util util;
    NewVulnerabilityTab newVulnerabilityTab;
    Preferences prefs = Preferences.userRoot().node(getClass().getName());
    static final String LAST_USED_FOLDER = "LAST_USED_FOLDER";


    public EvidencePopupMenu(NewVulnerabilityTab newVulnerabilityTab){//DefaultListModel<Evidence> evidenceListModel, JList evidenceList){
        this.newVulnerabilityTab = newVulnerabilityTab;
        this.util = new Util();

        addEvidence = new JMenuItem("Add file");

        addEvidence.addActionListener(e -> new Thread(() -> {
            JFileChooser jFileChooser = new JFileChooser(prefs.get(LAST_USED_FOLDER, new File(String.valueOf(FileSystemView.getFileSystemView().getDefaultDirectory())).getAbsolutePath()));
            int returnValue = jFileChooser.showOpenDialog(this);

            if (returnValue == JFileChooser.APPROVE_OPTION) {
                File selectedFile = jFileChooser.getSelectedFile();
                prefs.put(LAST_USED_FOLDER, jFileChooser.getSelectedFile().getParent());
                this.newVulnerabilityTab.addEvidence(new Evidence(selectedFile.getAbsolutePath(), selectedFile.getName()));
            }
        }).start());

        addTextEvidence = new JMenuItem("Add text");

        addTextEvidence.addActionListener(e -> {
            Dimension defaultDimension = (Dimension) UIManager.get("OptionPane.minimumSize");
            UIManager.put("OptionPane.minimumSize",new Dimension(250,250));

            JTextArea jTextArea = new JTextArea();
            jTextArea.setColumns(30);
            jTextArea.setLineWrap(true);
            jTextArea.setWrapStyleWord(true);
            jTextArea.setSize(jTextArea.getPreferredSize().width, jTextArea.getPreferredSize().height);

            JOptionPane.showMessageDialog(newVulnerabilityTab.getRootPanel2(), new JScrollPane(jTextArea), "Evidence content", JOptionPane.PLAIN_MESSAGE);
            UIManager.put("OptionPane.minimumSize", defaultDimension);

            String content = jTextArea.getText();
            if(!content.isEmpty()){
                File textEvidence = util.createTempFile("evidence-uid-", content);
                newVulnerabilityTab.addEvidence(new Evidence(textEvidence.getAbsolutePath(), textEvidence.getName()));
            }
        });

        removeEvidence = new JMenuItem("Remove");

        removeEvidence.addActionListener(e -> new Thread(() -> {
            this.newVulnerabilityTab.removeSelectedEvidence();
        }).start());

        add(addEvidence);
        add(addTextEvidence);
        add(removeEvidence);


    }

}
